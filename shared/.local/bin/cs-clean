#!/usr/bin/env bash
set -euo pipefail

# Codespace disk cleanup script
# Cleans logs, tmp files, and Docker artifacts to free disk space

SCRIPT_NAME="$(basename "$0")"
DRY_RUN=false
FORCE=false

usage() {
    cat <<EOF
Usage: $SCRIPT_NAME [OPTIONS]

Clean up disk space in a GitHub Codespace.

Options:
    -h, --help      Show this help message
    --dry-run       Show what would be cleaned without doing it
    --force         Skip confirmation prompt

What gets cleaned:
    - Log files older than 1 day in /workspaces/github/log/ (truncated, not deleted)
    - Contents of /workspaces/*/tmp/ directories
    - Stopped Docker containers
    - Dangling Docker images
EOF
}

log() {
    echo "==> $*"
}

warn() {
    echo "WARNING: $*" >&2
}

# Get human-readable size
human_size() {
    local bytes=$1
    if command -v numfmt &>/dev/null; then
        numfmt --to=iec --suffix=B "$bytes" 2>/dev/null || echo "${bytes}B"
    else
        echo "${bytes}B"
    fi
}

# Get size of a file or directory
get_size() {
    local path=$1
    if [[ -e "$path" ]]; then
        du -sb "$path" 2>/dev/null | cut -f1 || echo 0
    else
        echo 0
    fi
}

# Get total size of files matching find criteria
get_find_size() {
    local total=0
    while IFS= read -r file; do
        if [[ -f "$file" ]]; then
            size=$(stat -c%s "$file" 2>/dev/null || echo 0)
            total=$((total + size))
        fi
    done
    echo "$total"
}

# Clean log files older than 1 day
clean_logs() {
    local log_dir="/workspaces/github/log"
    
    log "Checking log files in $log_dir..."
    
    if [[ ! -d "$log_dir" ]]; then
        warn "Log directory does not exist: $log_dir"
        return 0
    fi
    
    local files_found=()
    local total_size=0
    
    while IFS= read -r -d '' file; do
        files_found+=("$file")
        size=$(stat -c%s "$file" 2>/dev/null || echo 0)
        total_size=$((total_size + size))
    done < <(find "$log_dir" -type f -mtime +0 -print0 2>/dev/null)
    
    if [[ ${#files_found[@]} -eq 0 ]]; then
        echo "   No log files older than 1 day found"
        return 0
    fi
    
    echo "   Found ${#files_found[@]} log file(s) to truncate ($(human_size "$total_size"))"
    
    if $DRY_RUN; then
        echo "   [DRY RUN] Would truncate:"
        for file in "${files_found[@]}"; do
            echo "     - $file"
        done
        return 0
    fi
    
    for file in "${files_found[@]}"; do
        : > "$file"
        echo "   Truncated: $file"
    done
    
    echo "   Freed approximately $(human_size "$total_size")"
    echo "$total_size"
}

# Clean tmp directories
clean_tmp() {
    local tmp_pattern="/workspaces/*/tmp"
    
    log "Checking tmp directories matching $tmp_pattern..."
    
    local dirs_found=()
    local total_size=0
    
    for tmp_dir in $tmp_pattern; do
        if [[ -d "$tmp_dir" ]]; then
            dirs_found+=("$tmp_dir")
            size=$(du -sb "$tmp_dir" 2>/dev/null | cut -f1 || echo 0)
            total_size=$((total_size + size))
        fi
    done
    
    if [[ ${#dirs_found[@]} -eq 0 ]]; then
        echo "   No tmp directories found"
        return 0
    fi
    
    echo "   Found ${#dirs_found[@]} tmp directory/directories ($(human_size "$total_size") total)"
    
    if $DRY_RUN; then
        echo "   [DRY RUN] Would clean contents of:"
        for dir in "${dirs_found[@]}"; do
            echo "     - $dir"
        done
        return 0
    fi
    
    for tmp_dir in "${dirs_found[@]}"; do
        if [[ -d "$tmp_dir" ]]; then
            # Remove contents but keep the directory itself
            find "$tmp_dir" -mindepth 1 -delete 2>/dev/null || true
            echo "   Cleaned: $tmp_dir"
        fi
    done
    
    echo "   Freed approximately $(human_size "$total_size")"
    echo "$total_size"
}

# Clean Docker artifacts
clean_docker() {
    log "Checking Docker artifacts..."
    
    if ! command -v docker &>/dev/null; then
        warn "Docker is not installed or not in PATH"
        return 0
    fi
    
    if ! docker info &>/dev/null; then
        warn "Docker daemon is not running or not accessible"
        return 0
    fi
    
    # Check stopped containers
    local stopped_containers
    stopped_containers=$(docker ps -aq --filter "status=exited" --filter "status=created" 2>/dev/null || true)
    local container_count=0
    if [[ -n "$stopped_containers" ]]; then
        container_count=$(echo "$stopped_containers" | wc -l)
    fi
    
    # Check dangling images
    local dangling_images
    dangling_images=$(docker images -q --filter "dangling=true" 2>/dev/null || true)
    local image_count=0
    local image_size=0
    if [[ -n "$dangling_images" ]]; then
        image_count=$(echo "$dangling_images" | wc -l)
        # Get total size of dangling images
        image_size=$(docker images --filter "dangling=true" --format "{{.Size}}" 2>/dev/null | \
            awk '{
                gsub(/B$/, ""); 
                multiplier=1;
                if (/KB$/) { gsub(/KB$/, ""); multiplier=1024 }
                else if (/MB$/) { gsub(/MB$/, ""); multiplier=1024*1024 }
                else if (/GB$/) { gsub(/GB$/, ""); multiplier=1024*1024*1024 }
                total += $1 * multiplier
            } END { print int(total) }' || echo 0)
    fi
    
    echo "   Stopped containers: $container_count"
    echo "   Dangling images: $image_count (approximately $(human_size "$image_size"))"
    
    if [[ $container_count -eq 0 && $image_count -eq 0 ]]; then
        echo "   Nothing to clean"
        return 0
    fi
    
    if $DRY_RUN; then
        echo "   [DRY RUN] Would remove:"
        if [[ $container_count -gt 0 ]]; then
            echo "     - $container_count stopped container(s)"
        fi
        if [[ $image_count -gt 0 ]]; then
            echo "     - $image_count dangling image(s)"
        fi
        return 0
    fi
    
    # Remove stopped containers
    if [[ $container_count -gt 0 ]]; then
        docker container prune -f >/dev/null 2>&1
        echo "   Removed $container_count stopped container(s)"
    fi
    
    # Remove dangling images only
    if [[ $image_count -gt 0 ]]; then
        docker image prune -f >/dev/null 2>&1
        echo "   Removed $image_count dangling image(s)"
    fi
    
    echo "   Freed approximately $(human_size "$image_size") (images only)"
    echo "$image_size"
}

# Show disk usage
show_disk_usage() {
    log "Current disk usage:"
    df -h / 2>/dev/null | tail -1 | awk '{print "   Used: " $3 " / " $2 " (" $5 " full)"}'
}

main() {
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                usage
                exit 0
                ;;
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            --force)
                FORCE=true
                shift
                ;;
            *)
                echo "Unknown option: $1" >&2
                usage >&2
                exit 1
                ;;
        esac
    done
    
    echo "Codespace Disk Cleanup"
    echo "======================"
    echo
    
    if $DRY_RUN; then
        echo "[DRY RUN MODE - No changes will be made]"
        echo
    fi
    
    show_disk_usage
    echo
    
    # Preview what will be cleaned
    log "Scanning for items to clean..."
    echo
    
    # If not dry run and not force, ask for confirmation
    if ! $DRY_RUN && ! $FORCE; then
        echo
        read -rp "Proceed with cleanup? [y/N] " confirm
        if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
            echo "Aborted."
            exit 0
        fi
        echo
    fi
    
    # Perform cleanup
    clean_logs
    echo
    clean_tmp
    echo
    clean_docker
    echo
    
    if ! $DRY_RUN; then
        log "Cleanup complete!"
        echo
        show_disk_usage
    else
        echo "[DRY RUN] No changes were made."
    fi
}

main "$@"
