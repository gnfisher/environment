#!/usr/bin/env bash
#
# Unified theme switcher for light/dark mode
# Switches: Ghostty, Neovim, Tmux, FZF
# OpenCode auto-follows system appearance.
# Color scheme: doom-one everywhere
#
# Usage:
#   theme light    - Switch to light mode
#   theme dark     - Switch to dark mode
#   theme toggle   - Toggle between light and dark
#   theme status   - Show current theme
#
# Can be triggered from Raycast, CLI, or macOS appearance change

set -euo pipefail

THEME_STATE_FILE="${XDG_STATE_HOME:-$HOME/.local/state}/theme-mode"

# Ensure state directory exists
mkdir -p "$(dirname "$THEME_STATE_FILE")"

# Resolve symlinks to get the real file path (sed -i doesn't work on symlinks)
resolve_path() {
    local path="$1"
    if [[ -L "$path" ]]; then
        local target
        target=$(readlink "$path")
        if [[ "$target" = /* ]]; then
            echo "$target"
        else
            local base_dir
            base_dir=$(cd -P "$(dirname "$path")" && pwd)
            local target_dir
            target_dir=$(cd -P "$(dirname "$base_dir/$target")" && pwd)
            echo "$target_dir/$(basename "$target")"
        fi
    else
        echo "$path"
    fi
}

get_current_theme() {
    if [[ -f "$THEME_STATE_FILE" ]]; then
        cat "$THEME_STATE_FILE"
    else
        echo "dark"
    fi
}

set_theme_state() {
    echo "$1" > "$THEME_STATE_FILE"
}

# Switch Ghostty theme (auto-reloads on config change)
switch_ghostty() {
    local mode="$1"
    local config_file="${XDG_CONFIG_HOME:-$HOME/.config}/ghostty/config"

    if [[ ! -f "$config_file" ]]; then
        return
    fi

    config_file=$(resolve_path "$config_file")

    local theme_value
    if [[ "$mode" == "light" ]]; then
        theme_value="doom-one-light"
    else
        theme_value="Doom One"
    fi

    sed -i '' "s/^theme = .*/theme = $theme_value/" "$config_file"
}

# Switch Neovim theme in all running instances
switch_neovim() {
    local mode="$1"
    
    # Find all Neovim server sockets
    local nvim_sockets=()
    
    # Check common socket locations
    if [[ -d "${XDG_RUNTIME_DIR:-/tmp}" ]]; then
        while IFS= read -r -d '' socket; do
            nvim_sockets+=("$socket")
        done < <(find "${XDG_RUNTIME_DIR:-/tmp}" -name 'nvim.*' -type s 2>/dev/null | tr '\n' '\0')
    fi
    
    # Also check /tmp for nvim sockets
    while IFS= read -r -d '' socket; do
        nvim_sockets+=("$socket")
    done < <(find /tmp -name 'nvim*' -type s 2>/dev/null | tr '\n' '\0')
    
    local bg_mode scheme
    if [[ "$mode" == "light" ]]; then
        bg_mode="light"
    else
        bg_mode="dark"
    fi
    scheme="doom-one"
    
    # Send commands to all running Neovim instances
    # Set background + colorscheme per mode
    for socket in "${nvim_sockets[@]}"; do
        if [[ -S "$socket" ]]; then
            nvim --server "$socket" --remote-send "<Cmd>set background=$bg_mode<CR><Cmd>colorscheme $scheme<CR>" 2>/dev/null || true
        fi
    done
}

# Switch Tmux theme
switch_tmux() {
    local mode="$1"
    
    if ! command -v tmux &>/dev/null || ! tmux list-sessions &>/dev/null; then
        return
    fi
    
    if [[ "$mode" == "light" ]]; then
        # Doom One Light colors
        tmux set -g status-style "bg=#f0f0f0,fg=#383a42"
        tmux set -g status-left "#[bg=#4078f2,fg=#fafafa,bold] #S #[default] "
        tmux set -g status-right "#[fg=#9ca0a4]#H"
        tmux set -g window-status-format "#[fg=#9ca0a4] #I:#W "
        tmux set -g window-status-current-format "#[bg=#e7e7e7,fg=#383a42,bold] #I:#W "
        tmux set -g pane-border-style "fg=#c6c7c7"
        tmux set -g pane-active-border-style "fg=#4078f2"
        tmux set -g message-style "bg=#e7e7e7,fg=#383a42"
        tmux set -g message-command-style "bg=#e7e7e7,fg=#383a42"
        tmux set -g mode-style "bg=#a626a4,fg=#fafafa"
    else
        # Doom One Dark colors
        tmux set -g status-style "bg=#21242b,fg=#bbc2cf"
        tmux set -g status-left "#[bg=#51afef,fg=#282c34,bold] #S #[default] "
        tmux set -g status-right "#[fg=#5b6268]#H"
        tmux set -g window-status-format "#[fg=#5b6268] #I:#W "
        tmux set -g window-status-current-format "#[bg=#3f444a,fg=#bbc2cf,bold] #I:#W "
        tmux set -g pane-border-style "fg=#3f444a"
        tmux set -g pane-active-border-style "fg=#51afef"
        tmux set -g message-style "bg=#3f444a,fg=#bbc2cf"
        tmux set -g message-command-style "bg=#3f444a,fg=#bbc2cf"
        tmux set -g mode-style "bg=#c678dd,fg=#282c34"
    fi
}

# Update FZF colors via environment variable
switch_fzf() {
    local mode="$1"
    local fish_theme_file="${XDG_CONFIG_HOME:-$HOME/.config}/fish/conf.d/fzf-theme.fish"
    
    if [[ "$mode" == "light" ]]; then
        # Doom One Light colors for FZF
        local fzf_opts="--color=bg+:#e7e7e7,bg:#fafafa,spinner:#a626a4,hl:#e45649 \
--color=fg:#383a42,header:#4078f2,info:#a626a4,pointer:#4078f2 \
--color=marker:#50a14f,fg+:#383a42,prompt:#a626a4,hl+:#e45649 \
--color=selected-bg:#dfdfdf \
--color=border:#c6c7c7,label:#383a42"
    else
        # Doom One Dark colors for FZF
        local fzf_opts="--color=bg+:#3f444a,bg:#282c34,spinner:#c678dd,hl:#ff6c6b \
--color=fg:#bbc2cf,header:#51afef,info:#c678dd,pointer:#51afef \
--color=marker:#98be65,fg+:#bbc2cf,prompt:#c678dd,hl+:#ff6c6b \
--color=selected-bg:#3f444a \
--color=border:#3f444a,label:#bbc2cf"
    fi
    
    # Update fish config file (resolve symlink first)
    if [[ -e "$fish_theme_file" ]]; then
        fish_theme_file=$(resolve_path "$fish_theme_file")
        cat > "$fish_theme_file" << EOF
# FZF theme - auto-generated by theme switcher
# Current mode: $mode
status is-interactive; or return

set -Ux FZF_DEFAULT_OPTS "$fzf_opts"
EOF
    fi
    
    # Export for current shell session
    export FZF_DEFAULT_OPTS="$fzf_opts"
}

# Detect macOS appearance
detect_macos_appearance() {
    if command -v defaults &>/dev/null; then
        local appearance
        appearance=$(defaults read -g AppleInterfaceStyle 2>/dev/null || echo "Light")
        if [[ "$appearance" == "Dark" ]]; then
            echo "dark"
        else
            echo "light"
        fi
    else
        echo "dark"
    fi
}

switch_all() {
    local mode="$1"
    
    echo "Switching to $mode mode..."
    
    switch_ghostty "$mode"
    switch_neovim "$mode"
    switch_tmux "$mode"
    switch_fzf "$mode"
    
    set_theme_state "$mode"
    
    echo "Done! Theme set to $mode"
}

case "${1:-status}" in
    light)
        switch_all "light"
        ;;
    dark)
        switch_all "dark"
        ;;
    toggle)
        current=$(get_current_theme)
        if [[ "$current" == "light" ]]; then
            switch_all "dark"
        else
            switch_all "light"
        fi
        ;;
    sync)
        # Sync with macOS appearance
        mode=$(detect_macos_appearance)
        switch_all "$mode"
        ;;
    status)
        current=$(get_current_theme)
        echo "Current theme: $current"
        ;;
    *)
        echo "Usage: theme [light|dark|toggle|sync|status]"
        exit 1
        ;;
esac
