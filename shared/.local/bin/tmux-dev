#!/usr/bin/env bash
# tmux-dev: Create a development session with nvim, agent, and lazygit windows
#
# Usage:
#   tmux-dev [path]     # Create session in path (defaults to current dir)
#   tmux-dev            # Create session in current directory
#
# Creates 3 windows:
#   1. <foldername> - nvim
#   2. agent        - shell (for opencode/copilot)
#   3. lazygit      - lazygit

set -e

# Get the target directory
target_dir="${1:-.}"
target_dir=$(cd "$target_dir" && pwd)
session_name=$(basename "$target_dir" | tr . _)

# Check if session already exists
if tmux has-session -t="$session_name" 2>/dev/null; then
    echo "Session '$session_name' already exists. Attaching..."
    if [[ -z "$TMUX" ]]; then
        tmux attach-session -t "$session_name"
    else
        tmux switch-client -t "$session_name"
    fi
    exit 0
fi

# Create new session with first window for nvim
tmux new-session -d -s "$session_name" -c "$target_dir" -n "$session_name"
tmux set-option -t "$session_name:1" automatic-rename off
tmux send-keys -t "$session_name" "nvim" C-m

# Create agent window (for opencode/copilot) - append after current
tmux new-window -t "$session_name:2" -c "$target_dir" -n "agent"
tmux set-option -t "$session_name:2" automatic-rename off

# Create lazygit window - append after agent
tmux new-window -t "$session_name:3" -c "$target_dir" -n "lazygit"
tmux set-option -t "$session_name:3" automatic-rename off
tmux send-keys -t "$session_name:lazygit" "lazygit" C-m

# Select the first window (nvim)
tmux select-window -t "$session_name:1"

# Attach or switch to session
if [[ -z "$TMUX" ]]; then
    tmux attach-session -t "$session_name"
else
    tmux switch-client -t "$session_name"
fi

echo "Created session '$session_name' with windows: $session_name, agent, lazygit"
